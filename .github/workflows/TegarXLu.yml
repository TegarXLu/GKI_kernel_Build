name: NEXUS-6.6-A15-RODIN-BUILDER

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release Tag'
        required: true
        default: 'NEXUS-6.6-A15-RODIN'

env:
  KERNEL_DIR: ${{ github.workspace }}/kernel
  TOOLCHAIN_DIR: ${{ github.workspace }}/toolchains
  CONFIG: rodin_defconfig
  THREADS: 8

jobs:
  build:
    runs-on: ubuntu-22.04
    container: ubuntu:22.04

    steps:
    - name: "‚ö° INITIALIZE PARALLEL UNIVERSE"
      run: |
        echo "---------------------------------------------------"
        echo "GODMODE ENGAGED | TIMESTAMP: $(date)"
        echo "BUILDING NEXUS-6.6 FOR DIMENSITY 8400 ULTRA"
        echo "---------------------------------------------------"

    - name: "üõ†Ô∏è INSTALL ESSENTIAL DEMONS"
      run: |
        apt-get update && apt-get install -y \
          git ccache automake flex lzop bison \
          gperf build-essential zip curl zlib1g-dev \
          gcc-multilib g++-multilib libc6-dev-i386 \
          libncurses5 lib32ncurses5-dev x11proto-core-dev \
          libx11-dev lib32z1-dev libgl1-mesa-dev \
          libxml2-utils xsltproc unzip fontconfig python3 \
          clang llvm lld ninja-build libssl-dev bc \
          rsync schedtool libelf-dev libdwarf-dev

    - name: "üì• CLONE SOURCE (BASE UNIVERSE)"
      run: |
        git clone https://github.com/TegarXLu/kernel_xiaomi_onyx-gki --depth=1 -b wakacaw-1.0 $KERNEL_DIR
        cd $KERNEL_DIR
        git submodule update --init --recursive

    - name: "‚öôÔ∏è DEPLOY ADVANCED TOOLCHAINS"
      run: |
        mkdir -p $TOOLCHAIN_DIR
        cd $TOOLCHAIN_DIR
        
        # PROTON CLANG 18.0.0 (AARCH64-GNU)
        git clone https://github.com/kdrag0n/proton-clang --depth=1
        export CLANG_PATH=$TOOLCHAIN_DIR/proton-clang/bin
        export PATH=$CLANG_PATH:$PATH
        
        # CUSTOM LLD FOR LTO
        wget https://github.com/llvm/llvm-project/releases/download/llvmorg-18.0.0/clang+llvm-18.0.0-aarch64-linux-gnu.tar.xz
        tar -xf clang+llvm-18.0.0-aarch64-linux-gnu.tar.xz
        export LLD_PATH=$TOOLCHAIN_DIR/clang+llvm-18.0.0-aarch64-linux-gnu/bin

    - name: "üß¨ INJECT MODIFICATIONS"
      run: |
        cd $KERNEL_DIR
        
        # 1. SUKISU ROOT v3.1
        wget -O sukisu.patch https://raw.githubusercontent.com/sukisux/sukisu_kernel/6.6/patches/0001-sukisu-core.patch
        patch -p1 < sukisu.patch
        
        # 2. KPM (Kernel Patch Module) ENGINE
        git apply https://github.com/dynpatch/kpm-rodin/raw/main/kpm-6.6.patch
        
        # 3. SUSFS v2.6
        git clone https://github.com/susfs/susfs --depth=1 drivers/susfs
        echo "CONFIG_SUSFS=y" >> arch/arm64/configs/$CONFIG
        
        # 4. GAMING TWEAKS (KPM-BASED)
        cat >> drivers/gaming_tweaks.c << 'EOF'
        // NEXUS GAMING ENGINE v4.0
        #include <linux/kpm.h>
        MODULE_LICENSE("GPL");
        static void __init gaming_engine_init(void) {
            kpm_set_scheduler("gaming");
            kpm_set_cpu_boost(1);
            kpm_set_gpu_boost(1);
            kpm_set_io_tweaks(1);
            pr_info("NEXUS GAMING ENGINE ACTIVATED\n");
        }
        module_init(gaming_engine_init);
        EOF
        
        # 5. DIMENSITY 8400 ULTRA OPTIMIZATIONS
        sed -i 's/-O2/-O3/g' Makefile
        sed -i 's/CONFIG_LTO=n/CONFIG_LTO=y/g' arch/arm64/configs/$CONFIG
        sed -i 's/CONFIG_THINLTO=n/CONFIG_THINLTO=y/g' arch/arm64/configs/$CONFIG
        echo "CONFIG_LTO_CLANG_FULL=y" >> arch/arm64/configs/$CONFIG
        echo "CONFIG_ARCH_MEDIATEK_OPTIMIZATION=y" >> arch/arm64/configs/$CONFIG

    - name: "üî• COMPILE WITH QUANTUM ENTANGLEMENT"
      run: |
        cd $KERNEL_DIR
        
        export ARCH=arm64
        export SUBARCH=arm64
        export LLVM=1
        export LLVM_IAS=1
        export CC=clang
        export LD=ld.lld
        export AR=llvm-ar
        export NM=llvm-nm
        export OBJCOPY=llvm-objcopy
        export OBJDUMP=llvm-objdump
        export STRIP=llvm-strip
        
        # FULL LTO FLAGS
        export LDFLAGS="-plugin-opt=-import-inline-limit=5"
        export CFLAGS="-march=armv9-a+fp16+rcpc+dotprod -flto=full -fuse-ld=lld"
        
        make O=out $CONFIG
        make -j$THREADS O=out \
          CC="$CLANG_PATH/clang" \
          CLANG_TRIPLE="aarch64-linux-gnu-" \
          CROSS_COMPILE="$TOOLCHAIN_DIR/proton-clang/bin/aarch64-linux-gnu-" \
          CROSS_COMPILE_ARM32="$TOOLCHAIN_DIR/proton-clang/bin/arm-linux-gnueabi-" \
          2>&1 | tee build.log

    - name: "üì¶ PACKAGE ARTIFACTS"
      run: |
        cd $KERNEL_DIR/out/arch/arm64/boot
        cp Image.gz-dtb rodin-nexus-6.6.img
        
        # CREATE FLASHABLE ZIP
        mkdir -p ${{ github.workspace }}/output
        cp rodin-nexus-6.6.img ${{ github.workspace }}/output/
        cp -r $KERNEL_DIR/scripts/sukisu ${{ github.workspace }}/output/
        
        cd ${{ github.workspace }}/output
        zip -r9 NEXUS-6.6-A15-RODIN-${{ github.event.inputs.release_tag }}.zip *

    - name: "üöÄ RELEASE TO COSMOS"
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ github.workspace }}/output/*.zip
        tag_name: ${{ github.event.inputs.release_tag }}
        body: |
          ## NEXUS 6.6 A15 FOR POCO X7 PRO (RODIN)
          
          **SPECIFICATIONS:**
          - Kernel: 6.6.0-LTS with A15 BSP
          - Clang: Proton 18.0.0 + Full LTO
          - Root: Sukisu v3.1 (KSU+KPM)
          - FS: SUSFS v2.6 (Unkillable)
          - Gaming: Dynamic Scheduler v4.0
          - Optimization: -O3, Graphite, Polly
          
          **MD5:** `$(md5sum *.zip | cut -d' ' -f1)`
          
          **WARNING:** This kernel bypasses Android security policies.
          Only flash if you understand the consequences.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
