name: build-TegarXLu_Kernel

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: 'Link repo kernel'
        required: true
        default: 'https://github.com/TegarXLu/Templar-Kernel-GKI-5.10'
      KERNEL_BRANCH:
        description: 'Branch kernel'
        required: true
        default: 'main'
      BUILD_KSUNEXT:
        description: 'Build KSUNext variant'
        type: boolean
        default: true
      RELEASE:
        description: 'Release kernel?'
        type: boolean
        default: true

jobs:
  set-date:
    runs-on: ubuntu-latest
    outputs:
      date: ${{ steps.getdate.outputs.date }}
    steps:
      - name: Get Current Date
        id: getdate
        run: echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        run: |
          MATRIX='['
          if [ "${{ github.event.inputs.BUILD_KSUNEXT }}" == "true" ]; then
            MATRIX+='{"name":"ksunext"},'
          fi
          MATRIX="${MATRIX%,}]"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
  build:
    needs: [setup-matrix]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    name: Build ${{ matrix.name }}

    steps:
      - name: Set up dependencies
        run: |
          sudo apt update
          sudo apt install -y git wget curl build-essential bc bison \
            flex libssl-dev libncurses-dev libelf-dev ccache python3 unzip

      - name: Set CONFIG Environment Variable
        run: |
          # Set CONFIG dynamically based on inputs values
          CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"

          # Set CONFIG as an environment variable for future steps
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV

      - name: Setup Build Environment
        run: |
          sudo apt update && sudo apt install -y libelf-dev libssl-dev build-essential
          
          AOSP_MIRROR=https://android.googlesource.com
          BRANCH=main-kernel-2025
          git clone $AOSP_MIRROR/kernel/prebuilts/build-tools -b $BRANCH --depth 1 kernel-build-tools &
          git clone $AOSP_MIRROR/platform/system/tools/mkbootimg -b $BRANCH --depth 1 mkbootimg &
          wait
          
          echo "AVBTOOL=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin/avbtool" >> $GITHUB_ENV
          echo "MKBOOTIMG=$GITHUB_WORKSPACE/mkbootimg/mkbootimg.py" >> $GITHUB_ENV
          echo "UNPACK_BOOTIMG=$GITHUB_WORKSPACE/mkbootimg/unpack_bootimg.py" >> $GITHUB_ENV
          echo "BOOT_SIGN_KEY_PATH=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/share/avb/testkey_rsa2048.pem" >> $GITHUB_ENV
          echo "PATH=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin:$PATH" >> $GITHUB_ENV
          
          mkdir -p ./git-repo
          curl https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          echo "REPO=$GITHUB_WORKSPACE/./git-repo/repo" >> $GITHUB_ENV     

      - name: Create Swap
        run: |
          sudo fallocate -l 10G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 ${{ github.event.inputs.KERNEL_REPO }} -b ${{ github.event.inputs.KERNEL_BRANCH }} kernel
      
      - name: Setup Worktree (for ksunext)
        if: matrix.name != 'noroot'
        run: |
          cd kernel
          git config user.name "TegarXLu"
          git config user.email "dimasnasution776@gmail.com"
          git branch -f temp-${{ matrix.name }} ${{ github.event.inputs.KERNEL_BRANCH }}
          git worktree add ../${{ matrix.name }} temp-${{ matrix.name }}

      - name: Inject Variant Patch (KSUNEXT)
        run: |
          if [[ "${{ matrix.name }}" == "ksunext" ]]; then
            cd ksunext
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s next
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s next-susfs
          fi

      - name: Clone & inspect .susfs (debug friendly)
        run: |
          set -euo pipefail
          set -x

          SUSFS_URL="https://gitlab.com/simonpunk/susfs4ksu.git"
          SUSFS_BRANCH="gki-android12-5.10"
          SUSFS_DIR=".susfs"

          echo "Working dir: $(pwd)"
          echo "Listing root:"
          ls -la .

          echo "Checking if branch exists on remote..."
          if git ls-remote --heads "$SUSFS_URL" "$SUSFS_BRANCH" | grep -q "refs/heads/$SUSFS_BRANCH"; then
            echo "Branch $SUSFS_BRANCH found on remote."
          else
            echo "ERROR: Branch $SUSFS_BRANCH NOT found on remote $SUSFS_URL"
            echo "Available heads on remote (first 20):"
            git ls-remote --heads "$SUSFS_URL" | sed -n '1,20p' || true
            exit 1
          fi

          # clone or update
          if [ ! -d "$SUSFS_DIR" ]; then
            echo "Cloning $SUSFS_URL branch $SUSFS_BRANCH into $SUSFS_DIR"
            git clone --depth=1 -b "$SUSFS_BRANCH" "$SUSFS_URL" "$SUSFS_DIR"
          else
            echo "$SUSFS_DIR exists â€” fetching/reset to $SUSFS_BRANCH"
            (cd "$SUSFS_DIR" && git fetch --depth=1 origin "$SUSFS_BRANCH" && git reset --hard "origin/$SUSFS_BRANCH")
          fi

          echo "Contents of $SUSFS_DIR (top-level):"
          ls -la "$SUSFS_DIR" || true

          kernel_patches="$(pwd)/$SUSFS_DIR/kernel_patches"
          echo "Expecting kernel_patches at: $kernel_patches"

          if [ ! -d "$kernel_patches" ]; then
            echo "ERROR: kernel_patches folder NOT found under $SUSFS_DIR."
            echo "Show $SUSFS_DIR tree (depth 3) for debugging:"
            # print a small tree; if tree not available, use find
            if command -v tree >/dev/null 2>&1; then
              tree -L 3 "$SUSFS_DIR" || true
            else
              find "$SUSFS_DIR" -maxdepth 3 -type d -print -o -type f -print | sed 's|^|  |'
            fi
            echo "---- End of debug. Please check that the branch and repository contain kernel_patches directory."
            exit 1
          fi

          echo "kernel_patches found. Listing files:"
          ls -la "$kernel_patches" || true

          echo "All good â€” proceed with copy/apply steps (not run in this step)."
        shell: bash
          
      - name: Download Clang
        run: |
          mkdir clang
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/d0e0a3882edb1acc193263ae98fce706e82aca38/clang-r574158.tar.gz -O clang.tar.gz
          tar -xf clang.tar.gz -C clang
      - name: Verify Clang availability
        run: |
          export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
          clang --version || exit 1
      
      - name: Set CONFIG_LOCALVERSION
        run: |
          if [[ "${{ matrix.name }}" == "ksunext" ]]; then
            DEFCONFIG=ksunext/arch/arm64/configs/gki_defconfig
            VERSION="-TegarXLu-KSUNext"
          fi
          sed -i '/CONFIG_LOCALVERSION/d' $DEFCONFIG
          echo "CONFIG_LOCALVERSION=\"$VERSION\"" >> $DEFCONFIG
      
      - name: Append CONFIG_HZ_300 and CONFIG_HZ=300 to defconfig
        run: |
          echo -e '\nCONFIG_HZ_300=y\nCONFIG_HZ=300' >> kernel/arch/arm64/configs/gki_defconfig

      - name: Apply Kernel Configuration
        run: |
          defconfig="kernel/arch/arm64/configs/gki_defconfig"
          
          echo "Applying kernel configurations one by one..."
          
          # KernelSU Core Configuration
          echo "CONFIG_KSU=y" >> "$defconfig"
          echo "CONFIG_KSU_KPROBES_HOOK=y" >> "$defconfig"
          
          # Mountify Support
          echo "CONFIG_TMPFS_XATTR=y" >> "$defconfig"
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> "$defconfig"
          
          # Networking Configuration
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> "$defconfig"
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> "$defconfig"
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> "$defconfig"
          
          # BBR TCP Congestion Control
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> "$defconfig"
          echo "CONFIG_TCP_CONG_BBR=y" >> "$defconfig"
          echo "CONFIG_NET_SCH_FQ=y" >> "$defconfig"
          echo "CONFIG_TCP_CONG_BIC=n" >> "$defconfig"
          echo "CONFIG_TCP_CONG_WESTWOOD=n" >> "$defconfig"
          echo "CONFIG_TCP_CONG_HTCP=n" >> "$defconfig"
          
          # IPSet support
          echo "CONFIG_IP_SET=y" >> "$defconfig"
          echo "CONFIG_IP_SET_MAX=256" >> "$defconfig"
          echo "CONFIG_IP_SET_BITMAP_IP=y" >> "$defconfig"
          echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> "$defconfig"
          echo "CONFIG_IP_SET_BITMAP_PORT=y" >> "$defconfig"
          echo "CONFIG_IP_SET_HASH_IP=y" >> "$defconfig"
          echo "CONFIG_IP_SET_HASH_IPPORT=y" >> "$defconfig"
          echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> "$defconfig"
          echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> "$defconfig"
          echo "CONFIG_IP_SET_HASH_NET=y" >> "$defconfig"
          echo "CONFIG_IP_SET_HASH_NETNET=y" >> "$defconfig"
          echo "CONFIG_IP_SET_HASH_NETPORT=y" >> "$defconfig"
          echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> "$defconfig"
          
          # SUSFS Configuration
          echo "CONFIG_KSU_SUSFS=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$defconfig"
          
          # SUSFS Auto Mount Features
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> "$defconfig"
          
          # SUSFS Advanced Features
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> "$defconfig"
          
          # SUSFS Debugging and Security
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> "$defconfig"
          echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> "$defconfig"
          
          # Build Optimization Configuration
          echo "CONFIG_LTO_CLANG_FULL=y" >> "$defconfig"
          echo "CONFIG_LTO_CLANG=y" >> "$defconfig"
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> "$defconfig"
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n" >> "$defconfig"
      
      - name: Build Kernel
        run: |
          cd ${{ matrix.name == 'ksunext' && 'kernel' || matrix.name }}
          export ARCH=arm64
          export SUBARCH=arm64
          export CLANG_PATH=$GITHUB_WORKSPACE/clang
          export PATH=$CLANG_PATH/bin:$PATH
          set -x
          set -e
          export CC=clang
          export CXX=clang++
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          export HOSTCC=clang
          export HOSTCXX=clang++
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LLVM=1
          export LLVM_IAS=1
          export LTO=full
          make O=out ARCH=arm64 gki_defconfig
          make -j$(nproc) O=out ARCH=arm64 LLVM=1 LLVM_IAS=1 LTO=full
      
      - name: Verify SUSFS Patch
        run: |
          echo "ðŸ” Verifying SUSFS in built kernel config..."
          if [[ "${{ matrix.name }}" == "ksunext" ]]; then
            CONFIG=kernel/out/.config
          else
            CONFIG=${{ matrix.name }}/out/.config
          fi
          grep -q "CONFIG_KSU=y" "$CONFIG" && echo "âœ… CONFIG_KSU found!" || echo "âŒ CONFIG_KSU not found!"
          grep -q "CONFIG_KSU_SUSFS=y" "$CONFIG" && echo "âœ… CONFIG_KSU_SUSFS found!" || echo "âŒ CONFIG_KSU_SUSFS not found!"
          grep -q "CONFIG_SECURITYFS=y" "$CONFIG" && echo "âœ… CONFIG_SECURITYFS found!" || echo "âŒ CONFIG_SECURITYFS not found!"
      
      - name: Package Kernel with AnyKernel3
        id: zipkernel
        run: |
          DATE=$(date +%Y%m%d)
          echo "DATE=$DATE" >> $GITHUB_ENV
          if [[ "${{ matrix.name }}" == "ksunext" ]]; then
            ZIP_NAME="TegarXLu-GKI-KSUNext+SUSFS-${DATE}.zip"
            OUT_DIR="ksunext"
          fi
          git clone https://github.com/TegarXLu/AnyKernel3
          cp $OUT_DIR/out/arch/arm64/boot/Image.gz AnyKernel3/
          cd AnyKernel3
          zip -r9 "../$ZIP_NAME" ./*
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.zipkernel.outputs.zip_name }}
          path: ${{ steps.zipkernel.outputs.zip_name }}

  finalize:
    needs: [set-date, build]
    runs-on: ubuntu-latest
    outputs:
      date: ${{ needs.set-date.outputs.date }}
    steps:
      - name: Dummy Finalize
        run: echo "Finalize completed"

  release:
    needs: [finalize]
    if: ${{ github.event.inputs.RELEASE == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: Generate Release Notes
        run: |
          echo "ðŸ”§ **TegarXLu GKI Release**" > release.txt
          if [[ "${{ github.event.inputs.BUILD_KSUNEXT }}" == "true" ]]; then
            echo "- ðŸ›¡ï¸ TegarXLu-GKI-KSUNext+SUSFS: With root KernelSU Next + SUSFS" >> release.txt
          fi
          echo "" >> release.txt
          echo "ðŸ“ **Notes:**" >> release.txt
          echo "- Based on AOSP GKI 5.10" >> release.txt
          echo "- SUSFS patch applied on KSUNext" >> release.txt
          echo "- Can be used on GKI-based devices (Android 12-5.10)" >> release.txt
          echo "" >> release.txt
          echo "ðŸ“„ <b>Full changelog</b>: [Here](${{ github.event.inputs.KERNEL_REPO }}/commits/${{ github.event.inputs.KERNEL_BRANCH }})" >> release.txt
          echo "ðŸ’¬ Bug reports: [Support Group](https://t.me/rmdnsupport)" >> release.txt
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: TegarXLu-GKI-${{ needs.finalize.outputs.date }}
          name: TegarXLu GKI - ${{ needs.finalize.outputs.date }}
          body_path: release.txt
          files: "**/*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
