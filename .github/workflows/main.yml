name: build-TegarXLu_Kernel_test

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: 'Link repo kernel'
        required: true
        default: 'https://github.com/marble-indonesia/kernel_xiaomi_sm8450'
      KERNEL_BRANCH:
        description: 'Branch kernel'
        required: true
        default: 'update-kernel'
      BUILD_NOROOT:
        description: 'Build Noroot variant'
        type: boolean
        default: false
      BUILD_KSUNEXT:
        description: 'Build KSUNext variant'
        type: boolean
        default: false
      BUILD_SUKISU:
        description: 'Build SukiSU variant'
        type: boolean
        default: true
      RELEASE:
        description: 'Release kernel?'
        type: boolean
        default: true

jobs:
  set-date:
    runs-on: ubuntu-latest
    outputs:
      date: ${{ steps.getdate.outputs.date }}
    steps:
      - name: Get Current Date
        id: getdate
        run: echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        run: |
          MATRIX='['
          if [ "${{ github.event.inputs.BUILD_NOROOT }}" == "true" ]; then
            MATRIX+='{"name":"noroot"},'
          fi
          if [ "${{ github.event.inputs.BUILD_KSUNEXT }}" == "true" ]; then
            MATRIX+='{"name":"ksunext"},'
          fi
          if [ "${{ github.event.inputs.BUILD_SUKISU }}" == "true" ]; then
            MATRIX+='{"name":"sukisu"},'
          fi
          MATRIX="${MATRIX%,}]"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
  build:
    needs: [setup-matrix]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    name: Build ${{ matrix.name }}

    steps:
      - name: Set up dependencies
        run: |
          sudo apt update
          sudo apt install -y git wget curl build-essential bc bison \
            flex libssl-dev libncurses-dev libelf-dev ccache python3 unzip
      - name: Set up ccache
        run: |
          mkdir -p ~/.cache/bazel
          ccache --version
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      - name: Create maximum-safe swap on device
        id: create_max_safe_swap
        run: |
          set -euo pipefail

          SWAP_PATH="${{ env.SWAP_PATH }}"
          MIN_FREE_GB=${{ env.MIN_FREE_GB }}
          MIN_SWAP_GB=${{ env.MIN_SWAP_GB }}
          MAX_CAP=${{ env.MAX_SWAP_CAP_GB }}

          # available (GB integer) on FS where workspace is mounted
          AVAIL_GB=$(df --output=avail -BG . | tail -1 | tr -dc '0-9')
          echo "Available before: ${AVAIL_GB}G"

          # desired = available - margin
          DESIRED=$((AVAIL_GB - MIN_FREE_GB))

          # apply absolute cap if set (>0)
          if [ "${MAX_CAP:-0}" -gt 0 ] && [ "$DESIRED" -gt "$MAX_CAP" ]; then
            DESIRED=$MAX_CAP
          fi

          if [ "$DESIRED" -lt "$MIN_SWAP_GB" ]; then
            echo "Not enough space to create swap. Desired=${DESIRED}G < MIN_SWAP_GB=${MIN_SWAP_GB}G"
            echo "swap_created=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "Initial desired swap: ${DESIRED}G (keeping ${MIN_FREE_GB}G free)"

          # ensure no leftover partial swap
          sudo swapoff "$SWAP_PATH" 2>/dev/null || true
          sudo rm -f "$SWAP_PATH" 2>/dev/null || true

          # re-check available space to avoid race with other steps
          AVAIL2_GB=$(df --output=avail -BG . | tail -1 | tr -dc '0-9')
          echo "Available now: ${AVAIL2_GB}G"
          # reduce DESIRED if needed to honor new availability
          if [ "$AVAIL2_GB" -lt $((DESIRED + MIN_FREE_GB)) ]; then
            DESIRED=$((AVAIL2_GB - MIN_FREE_GB))
            if [ "${MAX_CAP:-0}" -gt 0 ] && [ "$DESIRED" -gt "$MAX_CAP" ]; then
              DESIRED=$MAX_CAP
            fi
            echo "Adjusted desired swap based on current availability: ${DESIRED}G"
          fi

          if [ "$DESIRED" -lt "$MIN_SWAP_GB" ]; then
            echo "After adjust: not enough space (Desired=${DESIRED}G). Abort."
            echo "swap_created=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "Creating swap file: ${SWAP_PATH} size=${DESIRED}G"

          # try fallocate first (fast & fails early)
          if sudo fallocate -l ${DESIRED}G "$SWAP_PATH" 2>/dev/null; then
            echo "fallocate succeeded"
          else
            echo "fallocate failed â€” fallback to dd (slower). Will create ${DESIRED}G with dd."
            # dd count expects MBs; do integer math
            COUNT_MB=$((DESIRED * 1024))
            if ! sudo dd if=/dev/zero of="$SWAP_PATH" bs=1M count=$COUNT_MB status=progress 2>/dev/null; then
              echo "dd failed (likely ran out of space). Cleaning partial file and aborting."
              sudo rm -f "$SWAP_PATH" || true
              echo "swap_created=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          # verify file exists and has size
          if [ ! -f "$SWAP_PATH" ]; then
            echo "Swapfile not present after creation. Abort."
            echo "swap_created=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          sudo chmod 600 "$SWAP_PATH"
          sudo mkswap "$SWAP_PATH"
          sudo swapon "$SWAP_PATH"

          # confirm active
          swapon --show || true
          free -h || true

          echo "swap_created=true" >> $GITHUB_OUTPUT
          echo "swap_size_gb=${DESIRED}" >> $GITHUB_OUTPUT

      - name: Show disk after swap
        if: steps.create_max_safe_swap.outcome == 'success'
        run: df -h

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 ${{ github.event.inputs.KERNEL_REPO }} -b ${{ github.event.inputs.KERNEL_BRANCH }} kernel

      - name: Setup Worktree (for ksunext/sukisu)
        if: matrix.name != 'noroot'
        run: |
          cd kernel
          git config user.name "Ramadhani"
          git config user.email "ramadhanifals@gmail.com"
          git branch -f temp-${{ matrix.name }} ${{ github.event.inputs.KERNEL_BRANCH }}
          git worktree add ../${{ matrix.name }} temp-${{ matrix.name }}

      - name: Inject Variant Patch (KSU/SukiSU)
        run: |
          if [[ "${{ matrix.name }}" == "ksunext" ]]; then
            cd ksunext
            curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -
          elif [[ "${{ matrix.name }}" == "sukisu" ]]; then
            cd sukisu
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main
          fi

      - name: Download Clang
        run: |
          mkdir clang
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz -O clang.tar.gz
          tar -xf clang.tar.gz -C clang

      - name: Set CONFIG_LOCALVERSION
        run: |
          if [[ "${{ matrix.name }}" == "noroot" ]]; then
            DEFCONFIG=kernel/arch/arm64/configs/gki_defconfig
            VERSION="-WakacaW"
          elif [[ "${{ matrix.name }}" == "ksunext" ]]; then
            DEFCONFIG=ksunext/arch/arm64/configs/gki_defconfig
            VERSION="-WakacaW-KSUNext"
          elif [[ "${{ matrix.name }}" == "sukisu" ]]; then
            DEFCONFIG=sukisu/arch/arm64/configs/gki_defconfig
            VERSION="-WakacaW-SukiSU"
          fi
          sed -i '/CONFIG_LOCALVERSION/d' $DEFCONFIG
          echo "CONFIG_LOCALVERSION=\"$VERSION\"" >> $DEFCONFIG

      - name: Build Kernel
        run: |
          cd ${{ matrix.name == 'noroot' && 'kernel' || matrix.name }}
          export ARCH=arm64
          export SUBARCH=arm64
          export CLANG_PATH=$GITHUB_WORKSPACE/clang
          export PATH=$CLANG_PATH/bin:$PATH

          make O=out ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1 gki_defconfig
          make -j$(nproc) O=out ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1

      - name: Verify SUSFS Patch
        run: |
          echo "ðŸ” Verifying SUSFS in built kernel config..."
          if [[ "${{ matrix.name }}" == "noroot" ]]; then
            CONFIG=kernel/out/.config
          else
            CONFIG=${{ matrix.name }}/out/.config
          fi
          grep -q "CONFIG_KSU=y" "$CONFIG" && echo "âœ… CONFIG_KSU found!" || echo "âŒ CONFIG_KSU not found!"
          grep -q "CONFIG_KSU_SUSFS=y" "$CONFIG" && echo "âœ… CONFIG_KSU_SUSFS found!" || echo "âŒ CONFIG_KSU_SUSFS not found!"
          grep -q "CONFIG_SECURITYFS=y" "$CONFIG" && echo "âœ… CONFIG_SECURITYFS found!" || echo "âŒ CONFIG_SECURITYFS not found!"  
          
      - name: Package Kernel with AnyKernel3
        id: zipkernel
        run: |
          DATE=$(date +%Y%m%d)
          echo "DATE=$DATE" >> $GITHUB_ENV
          if [[ "${{ matrix.name }}" == "noroot" ]]; then
            ZIP_NAME="TegarXLu-GKI-${DATE}.zip"
            OUT_DIR="kernel"
          elif [[ "${{ matrix.name }}" == "ksunext" ]]; then
            ZIP_NAME="TegarXLu-GKI-KSUNext+SUSFS-${DATE}.zip"
            OUT_DIR="ksunext"
          elif [[ "${{ matrix.name }}" == "sukisu" ]]; then
            ZIP_NAME="TegarXLu-GKI-SukiSU+SUSFS-${DATE}.zip"
            OUT_DIR="sukisu"
          fi
          git clone https://github.com/TegarXLu/AnyKernel3
          cp $OUT_DIR/out/arch/arm64/boot/Image.gz AnyKernel3/
          cd AnyKernel3
          zip -r9 "../$ZIP_NAME" ./*
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.zipkernel.outputs.zip_name }}
          path: ${{ steps.zipkernel.outputs.zip_name }}

  finalize:
    needs: [set-date, build]
    runs-on: ubuntu-latest
    outputs:
      date: ${{ needs.set-date.outputs.date }}
    steps:
      - name: Dummy Finalize
        run: echo "Finalize completed"

  release:
    needs: [finalize]
    if: ${{ github.event.inputs.RELEASE == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: Generate Release Notes
        run: |
          echo "ðŸ”§ **TegarXLu GKI Release**" > release.txt
          if [[ "${{ github.event.inputs.BUILD_NOROOT }}" == "true" ]]; then
            echo "- ðŸ§© TegarXLu-GKI: Without root" >> release.txt
          fi
          if [[ "${{ github.event.inputs.BUILD_KSUNEXT }}" == "true" ]]; then
            echo "- ðŸ›¡ï¸ TegarXLu-GKI-KSUNext+SUSFS: With root KernelSU Next + SUSFS" >> release.txt
          fi
          if [[ "${{ github.event.inputs.BUILD_SUKISU }}" == "true" ]]; then
            echo "- ðŸ¦Š TegarXLu-GKI-SukiSU+SUSFS: With root SukiSU + SUSFS" >> release.txt
          fi
          echo "" >> release.txt
          echo "ðŸ“ **Notes:**" >> release.txt
          echo "- Based on AOSP GKI 5.10" >> release.txt
          echo "- SUSFS patch applied on SukiSU and KSUNext" >> release.txt
          echo "- Can be used on GKI-based devices (Android 12-5.10)" >> release.txt
          echo "" >> release.txt
          echo "ðŸ“„ <b>Full changelog</b>: [Here](${{ github.event.inputs.KERNEL_REPO }}/commits/${{ github.event.inputs.KERNEL_BRANCH }})" >> release.txt
          echo "ðŸ’¬ Bug reports: [Support Group](https://t.me/rmdnsupport)" >> release.txt
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: TegarXLu-GKI-${{ needs.finalize.outputs.date }}
          name: TegarXLu GKI - ${{ needs.finalize.outputs.date }}
          body_path: release.txt
          files: "**/*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup swap (always)
        if: always()
        run: |
          set -euo pipefail
          if [ -f /swapfile ]; then
            echo "Turning off swap and removing /swapfile"
            sudo swapoff /swapfile || true
            sudo rm -f /swapfile || true
          else
            echo "No /swapfile found"
          fi
          df -h || true
          free -h || true
