name: TegarXLu Kernel RESUKISU
# new Branch builtin
on:
  workflow_dispatch:
    inputs:
      kernel_name:
        description: 'Custom Kernel Name (Leave empty for default)'
        required: false
        default: ''
        type: string
      release_status:
        description: 'Release Status'
        required: true
        type: choice
        default: 'RELEASE'
        options:
          - 'RELEASE'
          - 'BETA'
      clang_version:
        description: 'Select Clang Version'
        required: true
        type: choice
        options:
          - 'r536225 (Clang 19)'
          - 'r547379 (Clang 20)'
      performance_patch:
        description: 'Select Device SoC for Performance Tuning (Internal)'
        required: true
        type: choice
        default: 'Mediatek'
        options:
          - 'MediaTek'
          - 'Universal'

permissions:
  contents: write

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04

    steps:
      - name: Free disk space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          swap-size-mb: 10240
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "TegarXLu"
          git config --global user.email "botdimas67@gmail.com"

      - name: Install build tools
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y git curl repo build-essential bc bison flex libssl-dev \
            libelf-dev python3 python3-pip unzip zip rsync libncurses-dev lld

      - name: Init & Sync GKI
        run: |
          mkdir gki && cd gki
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android15-6.6 --depth=1
          repo sync -c --no-tags --no-clone-bundle --optimized-fetch -j$(nproc --all)

      - name: Update kernel source for GKI 6.6
        run: |
          cd gki/common
          git remote add TegarXLu https://github.com/TegarXLu/onyx_clo.git
          git fetch -j12 TegarXLu
          git checkout -b susfs-6.6.77 TegarXLu/susfs-6.6.77

      - name: Apply MediaTek Performance Tuning
        if: github.event.inputs.performance_patch == 'MediaTek'
        working-directory: gki/common
        run: |
          echo "üöÄ [MediaTek] Applying performance tuning via defconfig (HZ=500)."
          echo "‚úÖ [MediaTek] Tuning will be applied in the 'Inject All Kernel Configs' step."

      - name: Tweak build config
        run: |
          sed -i '2d' gki/common/build.config.gki

      - name: Setup SukiSU & SUSFS
        run: |
          cd gki/common
          echo "[6/12] Setup ReSukiSU & SUSFS"
          curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash -s builtin
          echo "[‚úì] SUSFS already included in kernel source ‚Äî skipping patch"
          
      - name: Apply common fixes
        working-directory: gki/common
        run: |
          echo "Applying fixes for Kingfinik98 kernel source..."

      - name: Fix Stack Protector
        working-directory: gki/common
        run: |
          echo "üõ†Ô∏è Applying manual Stack Protector fix "
          sed -i '/config STACKPROTECTOR_PER_TASK/{n;s/def_bool y/bool "Stack Protector per task"\n\tdefault y/;}' arch/arm64/Kconfig
          echo "# CONFIG_STACKPROTECTOR_PER_TASK is not set" >> arch/arm64/configs/gki_defconfig
          echo "‚úÖ Stack Protector fix applied manually."

      - name: Patch module & DRM (Xiaomi Compat)
        working-directory: gki/common
        run: |
          echo "ü©π Menerapkan patch kompatibilitas untuk perangkat Xiaomi"
          sed -i '/pr_warn.*disagrees about version of symbol.*/,+1 s/.*/return 1;/' arch/arm64/kernel/module.c
          sed -i '/^static int drm_atomic_check_valid_clones/,/^}/d' drivers/gpu/drm/drm_atomic_helper.c
          sed -i '/ret = drm_atomic_check_valid_clones/,/return ret;/d' drivers/gpu/drm/drm_atomic_helper.c
          echo "‚úÖ Perbaikan selesai"

      - name: Remove check_defconfig
        run: |
          echo "üßπ [Clean-Up] Deleting check_defconfig"
          sed -i 's/check_defconfig//' gki/common/build.config.gki

      - name: Inject All Kernel Configs
        working-directory: gki/common
        run: |
          echo "‚öôÔ∏è Menambahkan konfigurasi kernel"
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          PERFORMANCE_PATCH="${{ github.event.inputs.performance_patch }}"
          cat >> $DEFCONFIG <<EOF
          # ===============================================
          # Config ResukiSU (SukiSU + SUSFS)
          CONFIG_KSU=y
          CONFIG_KPM=y
          CONFIG_KSU_SUSFS_SUS_SU=n
          CONFIG_KSU_SYSCALL_HOOK=n
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT_SPOOF_GENERIC=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_MANUAL_HOOK=n
          CONFIG_KSU_HAS_MANUAL_HOOK=n
          # GKI requires kprobes symbols to be present
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KRETPROBES=y
          CONFIG_KPROBE_EVENTS=y
          EOF
          if [ "$PERFORMANCE_PATCH" = "MediaTek" ]; then
            cat >> $DEFCONFIG <<EOF
          # --- MediaTek Performance Tuning ---
          CONFIG_HZ=500
          EOF
            echo "‚úÖ [MediaTek] Applied HZ=500 config."
          elif [ "$PERFORMANCE_PATCH" = "Universal" ]; then
            cat >> $DEFCONFIG <<EOF
          # --- Universal Configuration ---
          CONFIG_HZ_300=y
          CONFIG_CPU_FREQ=y
          CONFIG_HIGH_RES_TIMERS=y
          EOF
            echo "‚úÖ [Universal] Applied universal configuration."
          fi
          cat >> $DEFCONFIG <<EOF
          # Add additional tmpfs config setting
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          # Add additional config setting
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          # Add BBR Config
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_DEFAULT_BBR=y
          # Optimasi tambahan (Smooth & Responsiveness)
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_SCHED_TUNE=y
          CONFIG_MQ_IOSCHED_KYBER=y
          CONFIG_MQ_IOSCHED_BFQ=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          EOF

      - name: Set version
        working-directory: gki/common
        run: |
          echo "" > scripts/setlocalversion
          chmod +x scripts/setlocalversion
          KERNEL_NAME_INPUT="${{ github.event.inputs.kernel_name }}"
          PERFORMANCE_PATCH="${{ github.event.inputs.performance_patch }}"

          SUFFIX=""
          if [ -n "$KERNEL_NAME_INPUT" ]; then
            SUFFIX="-$KERNEL_NAME_INPUT"
          fi

          # Karena selalu menggunakan SUSFS, suffix ini tetap dipakai
          SUFFIX="$SUFFIX-‡∂û"

          if [ "$PERFORMANCE_PATCH" = "MediaTek" ]; then
            SUFFIX="$SUFFIX-Mtk"
          elif [ "$PERFORMANCE_PATCH" = "Universal" ]; then
            SUFFIX="$SUFFIX-Univ"
          fi
          
          echo "Setting custom kernel name: $SUFFIX"
          if grep -q '^EXTRAVERSION *=' Makefile; then
            sed -i "s/^EXTRAVERSION *=.*/EXTRAVERSION = $SUFFIX/" Makefile
          else
            echo "EXTRAVERSION = $SUFFIX" >> Makefile
          fi

      - name: Setup Clang
        working-directory: gki
        run: |
          mkdir -p prebuilts-master/clang/host/linux-x86
          if [ "${{ github.event.inputs.clang_version }}" == "r536225 (Clang 19)" ]; then
            CLANG_VER="clang-r536225"
            CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main-kernel-2025/clang-r536225.tar.gz"
          else
            CLANG_VER="clang-r547379"
            CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/62cdcefa89e31af2d72c366e8b5ef8db84caea62/clang-r547379.tar.gz"
          fi
          echo "CLANG_VER=$CLANG_VER" >> $GITHUB_ENV
          mkdir -p prebuilts-master/clang/host/linux-x86/$CLANG_VER
          cd prebuilts-master/clang/host/linux-x86
          curl -L "${CLANG_URL}" | tar -xz -C $CLANG_VER
          rm -rf clang-r563880b
          ln -sf $CLANG_VER clang-r563880b

      - name: Commit changes
        working-directory: gki/common
        run: |
          git add .
          git commit -m "Final clean tree before build" || true

      - name: Compile
        working-directory: gki/common
        run: |
          set -euo pipefail

          # --- konfigurasi clang / toolchain (sesuaikan kalau needed) ---
          PREBUILTS="$GITHUB_WORKSPACE/prebuilts-master/clang/host/linux-x86/clang-r536225"
          export PATH="$PREBUILTS/bin:$PATH"
          echo "Using clang: $(which clang || true)"

          # --- lokasi build config yang ingin dipakai (ubah bila berbeda) ---
          BUILD_CFG="$GITHUB_WORKSPACE/gki/common/build.config.gki.aarch64"

          # --- paksa LTO sesuai permintaan ---
          export LTO=thin

          # --- parse sederhana: baca KEY=VAL (abaikan komentar) dan export ---
          if [ -f "$BUILD_CFG" ]; then
            echo "Loading build config: $BUILD_CFG"
            while IFS= read -r line || [ -n "$line" ]; do
              # hapus komentar dan trim spasi
              line="${line%%#*}"
              line="${line##+([[:space:]])}"
              line="${line%%+([[:space:]])}"
              [ -z "$line" ] && continue
              # if line looks like KEY=VAL then export (quotes stripped)
              if printf '%s\n' "$line" | grep -qE '^[A-Za-z_][A-Za-z0-9_]*='; then
                key="${line%%=*}"
                val="${line#*=}"
                # remove surrounding quotes if any
                val="${val%\"}"
                val="${val#\"}"
                val="${val%\'}"
                val="${val#\'}"
                export "$key"="$val"
                echo "  -> exported $key"
              fi
            done < "$BUILD_CFG"
          else
            echo "Warning: $BUILD_CFG not found; continuing without BUILD_CONFIG."
          fi

          # --- gabungkan flags yang relevan menjadi KCFLAGS untuk make ---
          # build.config sering memakai EXTRA_CFLAGS / KBUILD_CFLAGS / KCFLAGS
          MAKE_KCFLAGS="${EXTRA_CFLAGS:-} ${KBUILD_CFLAGS:-} ${KCFLAGS:-}"
          # normalize whitespace
          MAKE_KCFLAGS="$(echo $MAKE_KCFLAGS)"

          echo "Final KCFLAGS: '${MAKE_KCFLAGS}'"
          echo "LTO mode: $LTO"

          # --- env build umum ---
          export ARCH=arm64
          export CC=clang
          export LD=ld.lld
          export LLVM=1
          export CROSS_COMPILE=aarch64-linux-gnu-

          OUTDIR="$GITHUB_WORKSPACE/gki/out/android15-6.6"
          mkdir -p "$OUTDIR"

          # --- generate defconfig (jika perlu) dan build ---
          echo "Running gki_defconfig..."
          make -C "$GITHUB_WORKSPACE/gki/common" O="$OUTDIR" ARCH=$ARCH gki_defconfig

          echo "Starting kernel build..."
          make -C "$GITHUB_WORKSPACE/gki/common" \
          O="$OUTDIR" \
            ARCH=$ARCH CC=$CC LLVM=$LLVM LD=$LD CROSS_COMPILE=${CROSS_COMPILE} \
            KCFLAGS="$MAKE_KCFLAGS" LTO="$LTO" -j$(nproc)

          echo "Build finished. Artifacts (if sukses) should be in: $OUTDIR"
      
      - name: Setup Environment Variables for Packaging
        id: vars
        run: |
          # Ambil versi DASAR kernel
          BASE_LINUX_VERSION=$(make -s kernelversion -C gki/common | tr -d '\n\r')
          echo "BASE_LINUX_VERSION=$BASE_LINUX_VERSION" >> $GITHUB_ENV
          
          # Ambil versi LENGKAP kernel (dengan suffix)
          LINUX_VERSION=$(make -s kernelversion -C gki/common | tr -d '\n\r')
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          
          CUSTOM_KERNEL_NAME="${{ github.event.inputs.kernel_name }}"
          if [ -z "$CUSTOM_KERNEL_NAME" ]; then
            KERNEL_NAME="BoltX"
          else
            KERNEL_NAME="$CUSTOM_KERNEL_NAME"
          fi

          STATUS="${{ github.event.inputs.release_status }}"
          CLANG_VERSION_STRING="${{ github.event.inputs.clang_version }}"

          # Hanya ada satu varian : ReSukiSU
          VARIANT="ReSukiSU"

          BUILD_DATE=$(date +"%Y%m%d")
          KBUILD_BUILD_TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S %Z")
          RELEASE="v${BUILD_DATE}"
          
          AK3_ZIP_NAME="AK3-${KERNEL_NAME}-${RELEASE}-${BASE_LINUX_VERSION}-${VARIANT}.zip"
          
          echo "KERNEL_NAME=$KERNEL_NAME" >> $GITHUB_ENV
          echo "VARIANT=$VARIANT" >> $GITHUB_ENV
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "RELEASE=$RELEASE" >> $GITHUB_ENV
          echo "AK3_ZIP_NAME=$AK3_ZIP_NAME" >> $GITHUB_ENV
          echo "KBUILD_BUILD_TIMESTAMP=$KBUILD_BUILD_TIMESTAMP" >> $GITHUB_ENV
          echo "KSU=ReSukiSU" >> $GITHUB_ENV
          echo "SUSFS_VERSION=$(curl -s https://gitlab.com/simonpunk/susfs4ksu/raw/gki-android15-6.6/kernel_patches/include/linux/susfs.h | grep -E '^#define SUSFS_VERSION' | cut -d' ' -f3 | sed 's/"//g')" >> $GITHUB_ENV
          echo "COMPILER_STRING=$CLANG_VERSION_STRING" >> $GITHUB_ENV

      - name: Package Kernel (AnyKernel3)
        run: |
          echo "üöÄ Starting kernel packaging process..."
          ANYKERNEL_REPO="https://github.com/linastorvaldz/anykernel"
          ANYKERNEL_BRANCH="android15-6.6"
          # Kembali ke path Image asli karena tidak ada patch KPM
          KERNEL_IMAGE="$GITHUB_WORKSPACE/gki/out/android15-6.6/dist/Image"
          echo "üîΩ Cloning anykernel from $ANYKERNEL_REPO"
          git clone -q --depth=1 $ANYKERNEL_REPO -b $ANYKERNEL_BRANCH anykernel
          
          KERNEL_STRING="${{ env.LINUX_VERSION }}"
          sed -i "s|kernel.string=.*|kernel.string=$KERNEL_STRING|g" anykernel/anykernel.sh

          cd anykernel
          echo "üóúÔ∏è Zipping anykernel..."
          cp "$KERNEL_IMAGE" .
          zip -r9 ../${{ env.AK3_ZIP_NAME }} ./*
          cd ..
          echo "‚úÖ Zip file created: ${{ env.AK3_ZIP_NAME }}"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üöÄ Creating GitHub Release..."
          GKI_RELEASES_REPO="https://github.com/TegarXLu/GKI_kernel_Build"
          REPO_PATH=$(echo "$GKI_RELEASES_REPO" | sed 's|https://github.com/||')
          RELEASE_TAG="${{ env.KERNEL_NAME }}-${{ env.LINUX_VERSION }}-${{ env.RELEASE }}"
          RELEASE_NOTES="üêß *Linux Version*: ${{ env.LINUX_VERSION }}
          üìÖ *Build Date*: ${{ env.KBUILD_BUILD_TIMESTAMP }}
          üìõ *ReSukiSU*: ${{ env.KSU }}
          ‡∂û *SuSFS*: ${{ env.SUSFS_VERSION }}
          üî∞ *Compiler*: ${{ env.COMPILER_STRING }}
          üîó *Method*: ReSukiSU + SUSFS"
          gh release create "$RELEASE_TAG" "${{ env.AK3_ZIP_NAME }}" \
            --title "$RELEASE_TAG" \
            --notes "$RELEASE_NOTES" \
            --repo "$REPO_PATH" \
            --latest
          echo "‚úÖ Release created successfully at https://github.com/$REPO_PATH/releases/tag/$RELEASE_TAG"

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.event.inputs.performance_patch }}
          path: gki/out/android15-6.6/common/build.log
          if-no-files-found: warn
