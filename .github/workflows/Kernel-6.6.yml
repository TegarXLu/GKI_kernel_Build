name: üß† Kernel Builder - SUKISU KPM + SUSFS

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version tag'
        required: true
        default: 'wakacaw-1.0'
      use_custom_patches:
        description: 'Apply custom patches'
        type: boolean
        default: true
      build_type:
        description: 'Build type'
        required: true
        default: 'GKI'
        type: choice
        options:
          - GKI
          - PERMISSIVE
          - ENG
      target_device:
        description: 'Target device'
        required: true
        default: 'onyx'
  push:
    branches: [ "main", "develop" ]
    paths:
      - '**.patch'
      - '**.diff'
      - 'config/**'
      - 'scripts/**'
  schedule:
    - cron: '0 0 * * 0'  # Weekly builds

env:
  KERNEL_REPO: 'https://github.com/TegarXLu/kernel_xiaomi_onyx-gki.git'
  KERNEL_BRANCH: 'wakacaw-1.0'
  CLANG_URL: 'https://github.com/llvm/llvm-project/releases/download/llvmorg-22.1.0-rc1/LLVM-22.1.0-rc1-Linux-ARM64.tar.xz'
  
  # SUKISU PATCHES - LATEST VERSIONS
  KPM_REPO: 'https://github.com/sukisu/KernelPatchManager.git'
  KPM_BRANCH: 'main'
  SUSFS_REPO: 'https://github.com/sukisu/susfs.git'
  SUSFS_BRANCH: 'main'
  
  # BUILD CONFIG
  ARCH: 'arm64'
  DEFCONFIG: 'onyx_defconfig'
  JOBS: 8
  BUILD_DIR: '${{ github.workspace }}/kernel_build'
  ARTIFACT_NAME: 'kernel-onyx-${{ github.run_number }}-${{ github.sha }}'

jobs:
  build-kernel:
    name: üõ†Ô∏è Build Kernel with SUKISU Patches
    runs-on: ubuntu-24.04  # ARM64 runner for native compilation
    timeout-minutes: 120

    steps:
    - name: üîÆ Checkout - GODMODE INITIATED
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: üåÄ Clone Kernel Source
      run: |
        echo "‚¨áÔ∏è Cloning kernel source..."
        git clone --depth=1 --branch="$KERNEL_BRANCH" "$KERNEL_REPO" "$BUILD_DIR/kernel"
        cd "$BUILD_DIR/kernel"
        echo "‚úÖ Kernel cloned at $(pwd)"
        git log --oneline -5

    - name: ‚ö° Setup LLVM Clang 22.1.0-rc1
      run: |
        echo "üß† Setting up LLVM Clang 22.1.0-rc1..."
        mkdir -p "$BUILD_DIR/clang"
        wget -q "$CLANG_URL" -O clang.tar.xz
        tar -xf clang.tar.xz -C "$BUILD_DIR/clang" --strip-components=1
        rm clang.tar.xz
        
        # Verify Clang
        CLANG_PATH="$BUILD_DIR/clang/bin/clang"
        if [ -f "$CLANG_PATH" ]; then
          echo "üéØ Clang version:"
          "$CLANG_PATH" --version | head -3
        else
          echo "‚ùå Clang not found!"
          exit 1
        fi

    - name: üî™ Clone & Apply SUKISU KPM (Latest)
      if: ${{ inputs.use_custom_patches }}
      run: |
        echo "‚öóÔ∏è Applying SUKISU Kernel Patch Manager..."
        KPM_DIR="$BUILD_DIR/patches/kpm"
        mkdir -p "$KPM_DIR"
        git clone --depth=1 --branch="$KPM_BRANCH" "$KPM_REPO" "$KPM_DIR"
        
        cd "$BUILD_DIR/kernel"
        
        # Find and apply KPM patches
        find "$KPM_DIR/patches" -name "*.patch" -type f | sort | while read patch; do
          echo "üß© Applying KPM patch: $(basename $patch)"
          patch -p1 --no-backup-if-mismatch < "$patch" || \
          echo "‚ö†Ô∏è  Patch might have been applied already or failed: $(basename $patch)"
        done
        
        # Check for KPM configs
        if [ -d "$KPM_DIR/configs" ]; then
          cp -r "$KPM_DIR/configs"/* "$BUILD_DIR/kernel/" 2>/dev/null || true
        fi

    - name: üõ°Ô∏è Clone & Apply SUKISU SUSFS (Latest)
      if: ${{ inputs.use_custom_patches }}
      run: |
        echo "üõ°Ô∏è Applying SUKISU SUSFS (Secure Userland Filesystem)..."
        SUSFS_DIR="$BUILD_DIR/patches/susfs"
        mkdir -p "$SUSFS_DIR"
        git clone --depth=1 --branch="$SUSFS_BRANCH" "$SUSFS_REPO" "$SUSFS_DIR"
        
        cd "$BUILD_DIR/kernel"
        
        # SUSFS integration
        if [ -f "$SUSFS_DIR/susfs-kernel.patch" ]; then
          echo "üîí Applying SUSFS kernel patch..."
          patch -p1 --no-backup-if-mismatch < "$SUSFS_DIR/susfs-kernel.patch"
        fi
        
        # Copy SUSFS sources if directory structure exists
        if [ -d "$SUSFS_DIR/kernel" ]; then
          echo "üìÅ Integrating SUSFS kernel module..."
          cp -r "$SUSFS_DIR/kernel"/* "$BUILD_DIR/kernel/" 2>/dev/null || true
        fi

    - name: üß™ Apply Custom Patches (User Defined)
      if: ${{ inputs.use_custom_patches }}
      run: |
        echo "üé® Applying user custom patches..."
        CUSTOM_PATCH_DIR="${{ github.workspace }}/patches"
        
        if [ -d "$CUSTOM_PATCH_DIR" ]; then
          cd "$BUILD_DIR/kernel"
          
          # Apply patches in numerical order
          find "$CUSTOM_PATCH_DIR" -name "*.patch" -type f | sort -V | while read patch; do
            echo "üõ†Ô∏è  Applying custom patch: $(basename $patch)"
            patch -p1 --no-backup-if-mismatch < "$patch" || \
            { echo "‚ùå Failed to apply: $(basename $patch)"; exit 1; }
          done
        else
          echo "üì≠ No custom patches directory found"
        fi

    - name: üîß Configure Kernel Build Environment
      run: |
        echo "‚öôÔ∏è Setting up build environment..."
        cd "$BUILD_DIR/kernel"
        
        # Install dependencies
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          rsync \
          kmod \
          cpio \
          git
        
        # Export environment variables
        echo "ARCH=$ARCH" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
        echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
        echo "PATH=$BUILD_DIR/clang/bin:$PATH" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
        
        # LLVM/Clang configuration
        echo "LLVM=1" >> $GITHUB_ENV
        echo "LLVM_IAS=1" >> $GITHUB_ENV
        echo "CC=clang" >> $GITHUB_ENV
        echo "LD=ld.lld" >> $GITHUB_ENV
        echo "AR=llvm-ar" >> $GITHUB_ENV
        echo "NM=llvm-nm" >> $GITHUB_ENV
        echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
        echo "OBJDUMP=llvm-objdump" >> $GITHUB_ENV
        echo "STRIP=llvm-strip" >> $GITHUB_ENV

    - name: üß¨ Generate Kernel Configuration
      run: |
        echo "üß¨ Generating kernel configuration..."
        cd "$BUILD_DIR/kernel"
        
        # Create out directory
        mkdir -p out
        
        # Generate base config
        make O=out ARCH=$ARCH $DEFCONFIG
        
        # Interactive menuconfig if needed (for debugging)
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "üîß Configuration generated at out/.config"
          head -50 out/.config
        fi

    - name: üöÄ Build Kernel with SUKISU Modifications
      run: |
        echo "‚ö° Building kernel with GODMODE optimizations..."
        cd "$BUILD_DIR/kernel"
        
        # Start build process
        BUILD_START=$(date +%s)
        
        make -j$JOBS O=out ARCH=$ARCH \
          CC="$CC" \
          LD="$LD" \
          AR="$AR" \
          NM="$NM" \
          OBJCOPY="$OBJCOPY" \
          OBJDUMP="$OBJDUMP" \
          STRIP="$STRIP" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CROSS_COMPILE_ARM32="$CROSS_COMPILE_ARM32" \
          LLVM=1 \
          LLVM_IAS=1 \
          2>&1 | tee build.log
        
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo "‚úÖ Build completed in ${BUILD_TIME} seconds"
        
        # Verify build output
        if [ -f "out/arch/$ARCH/boot/Image" ]; then
          echo "üéØ Kernel Image found!"
          ls -lh "out/arch/$ARCH/boot/"
        else
          echo "‚ùå Kernel Image not found!"
          cat build.log | tail -100
          exit 1
        fi

    - name: üì¶ Package Kernel Artifacts
      run: |
        echo "üì¶ Packaging kernel artifacts..."
        ARTIFACT_DIR="$BUILD_DIR/artifacts"
        mkdir -p "$ARTIFACT_DIR"
        
        cd "$BUILD_DIR/kernel"
        
        # Copy essential files
        cp out/arch/$ARCH/boot/Image "$ARTIFACT_DIR/"
        cp out/.config "$ARTIFACT_DIR/config"
        cp System.map "$ARTIFACT_DIR/" 2>/dev/null || true
        cp out/Module.symvers "$ARTIFACT_DIR/" 2>/dev/null || true
        
        # Copy modules if any
        if [ -d "out/modules" ]; then
          mkdir -p "$ARTIFACT_DIR/modules"
          find out/modules -name "*.ko" -exec cp {} "$ARTIFACT_DIR/modules/" \;
        fi
        
        # Create build info
        cat > "$ARTIFACT_DIR/build.info" << EOF
        Kernel Build Information
        ========================
        Build Date: $(date)
        Git SHA: ${{ github.sha }}
        Run Number: ${{ github.run_number }}
        Kernel Version: $(make kernelversion 2>/dev/null || echo "Unknown")
        SUKISU KPM: $(cd $BUILD_DIR/patches/kpm 2>/dev/null && git rev-parse --short HEAD || echo "Not applied")
        SUKISU SUSFS: $(cd $BUILD_DIR/patches/susfs 2>/dev/null && git rev-parse --short HEAD || echo "Not applied")
        Build Type: ${{ inputs.build_type }}
        Target Device: ${{ inputs.target_device }}
        EOF
        
        # Create flashable package (AnyKernel3 style)
        mkdir -p "$ARTIFACT_DIR/anykernel"
        cat > "$ARTIFACT_DIR/anykernel/anykernel.sh" << 'EOF'
        #!/system/bin/sh
        # AnyKernel3 Script for SUKISU Patched Kernel
        
        ## AnyKernel setup
        begin
        
        ## AnyKernel permissions
        set_permissions
        
        ## AnyKernel kernel install
        dump_boot
        
        patch_cmdline "SUKISU_KPM" "enabled"
        patch_cmdline "SUKISU_SUSFS" "enabled"
        
        write_boot
        end
        
        ## AnyKernel file attributes
        chmod -R 755 $MODPATH
        EOF
        
        # Create zip archive
        cd "$ARTIFACT_DIR"
        zip -r9 "$ARTIFACT_NAME.zip" .

    - name: üì§ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.run_number }}
        path: |
          ${{ env.BUILD_DIR }}/artifacts/
          ${{ env.BUILD_DIR }}/kernel/build.log
        retention-days: 7

    - name: üìä Build Report
      if: always()
      run: |
        echo "üìä BUILD REPORT" >> $GITHUB_STEP_SUMMARY
        echo "===============" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "$BUILD_DIR/kernel/out/arch/$ARCH/boot/Image" ]; then
          IMAGE_SIZE=$(stat -c%s "$BUILD_DIR/kernel/out/arch/$ARCH/boot/Image")
          echo "**‚úÖ Kernel Build Successful**" >> $GITHUB_STEP_SUMMARY
          echo "- Kernel Image: $(($IMAGE_SIZE / 1024 / 1024))MB" >> $GITHUB_STEP_SUMMARY
          echo "- Architecture: $ARCH" >> $GITHUB_STEP_SUMMARY
          echo "- SUKISU KPM: Applied" >> $GITHUB_STEP_SUMMARY
          echo "- SUKISU SUSFS: Applied" >> $GITHUB_STEP_SUMMARY
        else
          echo "**‚ùå Kernel Build Failed**" >> $GITHUB_STEP_SUMMARY
          echo "Check build logs for details" >> $GITHUB_STEP_SUMMARY
        fi

  notify:
    name: üì¢ Notification
    needs: build-kernel
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: üì® Discord Notification
        if: ${{ failure() }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "üö® Kernel Build Failed"
          description: "Build #${{ github.run_number }} failed for ${{ github.repository }}"
          color: 0xFF0000
          
      - name: üéâ Success Notification
        if: ${{ success() }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "‚úÖ Kernel Build Successful"
          description: "Build #${{ github.run_number }} completed successfully!"
          color: 0x00FF00
