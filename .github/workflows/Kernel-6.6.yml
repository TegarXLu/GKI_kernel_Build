name: üß† Pure Kernel Builder - LTO Optimized

on:
  workflow_dispatch:
    inputs:
      lto_level:
        description: 'LTO Optimization Level'
        required: true
        default: 'full'
        type: choice
        options:
          - 'thin'
          - 'full'
          - 'fat'
      optimization:
        description: 'Optimization Profile'
        required: true
        default: 'performance'
        type: choice
        options:
          - 'performance'
          - 'balanced'
          - 'size'
  push:
    branches: [ "main" ]
    paths:
      - 'kernel-configs/**'
      - 'Makefile'
      - 'Kconfig'
  schedule:
    - cron: '0 0 * * 0'  # Weekly purity checks

env:
  KERNEL_REPO: 'https://github.com/TegarXLu/kernel_xiaomi_onyx-gki.git'
  KERNEL_BRANCH: 'wakacaw-1.0'
  CLANG_URL: 'https://github.com/llvm/llvm-project/releases/download/llvmorg-22.1.0-rc1/LLVM-22.1.0-rc1-Linux-ARM64.tar.xz'
  
  # GODMODE LTO FLAGS
  LTO_LEVEL: 'full'
  OPTIMIZATION: 'performance'
  
  # PURIST CONFIGURATION
  ARCH: 'arm64'
  DEFCONFIG: 'onyx_gki_defconfig'
  BUILD_DIR: '${{ github.workspace }}/kernel_build'
  ARTIFACT_NAME: 'pure-kernel-${{ github.sha }}-${{ github.run_number }}'

  # EXPLICITLY DISABLED
  NO_SUKISU: '1'
  NO_KPM: '1'
  NO_SUSFS: '1'
  NO_ROOT_MODS: '1'

jobs:
  build-pure-kernel:
    name: ‚ö° Build Pure Kernel (LTO Optimized)
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
    - name: üßπ Clean Workspace - Purge Impurities
      run: |
        echo "üî• Purging all non-essential elements..."
        rm -rf ${{ github.workspace }}/kernel_build 2>/dev/null || true
        echo "‚úÖ Workspace purified"

    - name: üì• Clone Kernel Source (Vanilla)
      run: |
        echo "‚¨áÔ∏è Cloning pure kernel source..."
        git clone --depth=1 \
          --branch="$KERNEL_BRANCH" \
          --single-branch \
          --no-tags \
          "$KERNEL_REPO" \
          "$BUILD_DIR/kernel"
        
        cd "$BUILD_DIR/kernel"
        echo "‚úÖ Kernel cloned: $(git log --oneline -1)"
        echo "üìè Repository size: $(du -sh . | cut -f1)"

    - name: ‚öôÔ∏è Setup LLVM Clang 22.1.0-rc1
      run: |
        echo "üß† Installing minimal build dependencies..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          bc \
          flex \
          bison \
          libelf-dev \
          libssl-dev \
          rsync
        
        echo "‚¨áÔ∏è Downloading Clang 22.1.0-rc1..."
        mkdir -p "$BUILD_DIR/clang"
        wget -q "$CLANG_URL" -O clang.tar.xz
        tar -xf clang.tar.xz -C "$BUILD_DIR/clang" --strip-components=1
        rm clang.tar.xz
        
        # Verify
        "$BUILD_DIR/clang/bin/clang" --version | head -2

    - name: üö´ Verify No Root/SUKISU Contamination
      run: |
        echo "üîç Scanning for impurities..."
        cd "$BUILD_DIR/kernel"
        
        # Check for SUKISU/KPM/SUSFS
        if grep -r "sukisu\|KPM\|SUSFS" --include="*.c" --include="*.h" --include="Kconfig" --include="Makefile" .; then
          echo "‚ùå IMPURITY DETECTED!"
          exit 1
        fi
        
        # Check for root-specific modifications
        if grep -r "CONFIG_KSU\|CONFIG_MAGISK\|superuser" --include="*.config" . 2>/dev/null; then
          echo "‚ùå ROOT MODIFICATIONS DETECTED!"
          exit 1
        fi
        
        echo "‚úÖ No impurities found. System is pure."

    - name: ‚ö° Configure LTO Build Environment
      run: |
        echo "‚ö° Configuring LTO environment..."
        cd "$BUILD_DIR/kernel"
        
        # Export LTO configuration
        case "${{ github.event.inputs.lto_level || 'full' }}" in
          'thin')
            export LTO_MODE='thin'
            export LTO_CFLAGS='-flto=thin -fuse-ld=lld'
            ;;
          'full')
            export LTO_MODE='full'
            export LTO_CFLAGS='-flto -fuse-ld=lld'
            ;;
          'fat')
            export LTO_MODE='fat'
            export LTO_CFLAGS='-flto -fuse-ld=lld -ffat-lto-objects'
            ;;
        esac
        
        # Optimization profile
        case "${{ github.event.inputs.optimization || 'performance' }}" in
          'performance')
            export OPT_CFLAGS='-O3 -march=armv8.5-a+crypto+rcpc+dotprod -mcpu=cortex-a715 -mtune=cortex-a715'
            ;;
          'balanced')
            export OPT_CFLAGS='-O2 -march=armv8.4-a+crypto -mcpu=cortex-a75 -mtune=cortex-a75'
            ;;
          'size')
            export OPT_CFLAGS='-Os -march=armv8-a -mcpu=cortex-a53'
            ;;
        esac
        
        # Full environment setup
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        echo "PATH=$BUILD_DIR/clang/bin:$PATH" >> $GITHUB_ENV
        
        # LLVM Configuration
        echo "LLVM=1" >> $GITHUB_ENV
        echo "LLVM_IAS=1" >> $GITHUB_ENV
        echo "CC=clang" >> $GITHUB_ENV
        echo "LD=ld.lld" >> $GITHUB_ENV
        echo "AR=llvm-ar" >> $GITHUB_ENV
        echo "NM=llvm-nm" >> $GITHUB_ENV
        echo "STRIP=llvm-strip" >> $GITHUB_ENV
        echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
        
        # LTO Flags
        echo "LTO_CFLAGS=$LTO_CFLAGS" >> $GITHUB_ENV
        echo "OPT_CFLAGS=$OPT_CFLAGS" >> $GITHUB_ENV
        echo "KBUILD_CFLAGS=$OPT_CFLAGS $LTO_CFLAGS" >> $GITHUB_ENV
        echo "KBUILD_LDFLAGS=$LTO_CFLAGS" >> $GITHUB_ENV

    - name: üîß Configure Kernel with LTO
      run: |
        echo "üîß Generating kernel configuration with LTO..."
        cd "$BUILD_DIR/kernel"
        
        # Create output directory
        mkdir -p out
        
        # Generate base config
        make O=out ARCH=arm64 $DEFCONFIG
        
        # Enable LTO in config
        echo "üîÑ Enabling LTO in kernel configuration..."
        ./scripts/config --file out/.config \
          --enable LTO_CLANG \
          --enable LTO \
          --enable LTO_CLANG_FULL \
          --disable LTO_CLANG_THIN \
          --enable HAVE_LTO_CLANG_FULL
        
        # Disable any root-related options
        ./scripts/config --file out/.config \
          --disable KSU \
          --disable OVERLAY_FS_REDIRECT_DIR \
          --disable MAGISK_POLICY_FS \
          --disable NON_ROOT_NS \
          --disable ROOT_NS
        
        # Optimize for size/performance based on selection
        if [ "${{ github.event.inputs.optimization || 'performance' }}" = "size" ]; then
          ./scripts/config --file out/.config \
            --enable CC_OPTIMIZE_FOR_SIZE \
            --disable CC_OPTIMIZE_FOR_PERFORMANCE
        else
          ./scripts/config --file out/.config \
            --disable CC_OPTIMIZE_FOR_SIZE \
            --enable CC_OPTIMIZE_FOR_PERFORMANCE
        fi
        
        # Update config
        make O=out ARCH=arm64 olddefconfig
        
        echo "üìã LTO Configuration applied:"
        grep "LTO" out/.config

    - name: ‚ö° Build Pure LTO Kernel
      run: |
        echo "‚ö° Building pure LTO-optimized kernel..."
        cd "$BUILD_DIR/kernel"
        
        BUILD_START=$(date +%s)
        
        # Build with explicit flags
        make -j$(nproc) O=out ARCH=arm64 \
          CC="clang" \
          LD="ld.lld" \
          AR="llvm-ar" \
          NM="llvm-nm" \
          STRIP="llvm-strip" \
          OBJCOPY="llvm-objcopy" \
          OBJDUMP="llvm-objdump" \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          CROSS_COMPILE_ARM32="arm-linux-gnueabi-" \
          LLVM=1 \
          LLVM_IAS=1 \
          KCFLAGS="$KBUILD_CFLAGS" \
          KLDFLAGS="$KBUILD_LDFLAGS" \
          2>&1 | tee build.log
        
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo "‚úÖ Build completed in ${BUILD_TIME} seconds"
        
        # Verify
        if [ -f "out/arch/arm64/boot/Image" ]; then
          SIZE=$(stat -c%s "out/arch/arm64/boot/Image")
          echo "üì¶ Kernel Size: $(($SIZE / 1024 / 1024))MB"
        else
          echo "‚ùå Build failed - no kernel image"
          tail -100 build.log
          exit 1
        fi

    - name: üìä Analyze LTO Results
      run: |
        echo "üìä LTO Build Analysis Report"
        echo "============================="
        cd "$BUILD_DIR/kernel"
        
        # Check LTO sections
        echo "üîç Checking LTO optimization..."
        if command -v llvm-size >/dev/null 2>&1; then
          llvm-size out/vmlinux 2>/dev/null || true
        fi
        
        # Check for LTO sections
        echo "üìà LTO Statistics:"
        if [ -f "out/vmlinux" ]; then
          readelf -S out/vmlinux 2>/dev/null | grep -i lto || echo "No specific LTO sections found"
        fi
        
        # Symbol analysis
        echo "üè∑Ô∏è  Symbol table size:"
        nm out/vmlinux 2>/dev/null | wc -l || echo "Cannot count symbols"

    - name: üì¶ Package Pure Artifacts
      run: |
        echo "üì¶ Packaging pure kernel artifacts..."
        ARTIFACT_DIR="$BUILD_DIR/artifacts"
        mkdir -p "$ARTIFACT_DIR"
        
        cd "$BUILD_DIR/kernel"
        
        # Copy only essential files
        cp out/arch/arm64/boot/Image "$ARTIFACT_DIR/Image.pure"
        cp out/.config "$ARTIFACT_DIR/config.pure"
        
        # Generate minimalist info
        cat > "$ARTIFACT_DIR/pure.info" << EOF
        PURE KERNEL BUILD
        =================
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Commit: ${{ github.sha }}
        Build ID: ${{ github.run_number }}
        
        PURITY STATUS:
        - SUKISU: ABSENT
        - KPM: ABSENT
        - SUSFS: ABSENT
        - ROOT MODS: ABSENT
        
        OPTIMIZATION:
        - LTO Level: ${{ github.event.inputs.lto_level || 'full' }}
        - Profile: ${{ github.event.inputs.optimization || 'performance' }}
        - Clang: 22.1.0-rc1
        - Architecture: arm64
        
        SIZE INFORMATION:
        - Kernel: $(stat -c%s "out/arch/arm64/boot/Image" | awk '{printf "%.2f MB", $1/1024/1024}')
        - Config: $(wc -l < out/.config) lines
        
        BUILD LOGIC:
        "Complexity is the enemy of security.
        Purity is the foundation of stability."
        EOF
        
        # Create verification script
        cat > "$ARTIFACT_DIR/verify_purity.sh" << 'EOF'
        #!/bin/bash
        # Pure Kernel Verification Script
        
        echo "üîç Verifying kernel purity..."
        
        if [ ! -f "Image.pure" ]; then
            echo "‚ùå Kernel image not found"
            exit 1
        fi
        
        # Check for strings that should NOT exist
        FORBIDDEN_STRINGS=("sukisu" "KPM" "SUSFS" "magisk" "ksu" "rootkit")
        
        for forbidden in "${FORBIDDEN_STRINGS[@]}"; do
            if strings "Image.pure" | grep -i "$forbidden" >/dev/null; then
                echo "‚ùå IMPURITY DETECTED: $forbidden"
                exit 1
            fi
        done
        
        echo "‚úÖ Kernel is pure. No contaminants detected."
        EOF
        
        chmod +x "$ARTIFACT_DIR/verify_purity.sh"
        
        # Create flashable package (minimalist)
        mkdir -p "$ARTIFACT_DIR/flash"
        cat > "$ARTIFACT_DIR/flash/flash.sh" << 'EOF'
        #!/system/bin/sh
        
        # Minimalist flash script
        # No bloat, no root, no modifications
        
        ui_print " "
        ui_print "================================"
        ui_print "   PURE KERNEL FLASH"
        ui_print "   No root, no bloat, no nonsense"
        ui_print "================================"
        
        # Backup original kernel
        dd if=/dev/block/by-name/boot of=/tmp/boot_backup.img
        
        # Flash new kernel
        dd if=/tmp/Image.pure of=/dev/block/by-name/boot
        
        ui_print "‚úÖ Pure kernel flashed successfully"
        ui_print "‚ö†Ô∏è  No root modifications included"
        EOF
        
        chmod +x "$ARTIFACT_DIR/flash/flash.sh"
        
        # Create final zip
        cd "$ARTIFACT_DIR"
        zip -r9 "$ARTIFACT_NAME.zip" .

    - name: üì§ Upload Pure Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pure-kernel-${{ github.run_number }}
        path: |
          ${{ env.BUILD_DIR }}/artifacts/
          ${{ env.BUILD_DIR }}/kernel/build.log
        retention-days: 30

    - name: üìà Generate Purity Report
      if: always()
      run: |
        echo "# PURITY BUILD REPORT" >> $GITHUB_STEP_SUMMARY
        echo "## üß™ Build #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "$BUILD_DIR/kernel/out/arch/arm64/boot/Image" ]; then
          echo "‚úÖ **BUILD SUCCESSFUL**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Purity Status:**" >> $GITHUB_STEP_SUMMARY
          echo "- üö´ SUKISU: Not present" >> $GITHUB_STEP_SUMMARY
          echo "- üö´ KPM: Not present" >> $GITHUB_STEP_SUMMARY
          echo "- üö´ SUSFS: Not present" >> $GITHUB_STEP_SUMMARY
          echo "- üö´ Root mods: Not present" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          SIZE=$(stat -c%s "$BUILD_DIR/kernel/out/arch/arm64/boot/Image")
          echo "**Build Info:**" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(($SIZE / 1024 / 1024)) MB" >> $GITHUB_STEP_SUMMARY
          echo "- LTO: ${{ github.event.inputs.lto_level || 'full' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Optimization: ${{ github.event.inputs.optimization || 'performance' }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **BUILD FAILED**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check build logs for details" >> $GITHUB_STEP_SUMMARY
        fi

  security-scan:
    name: üîí Security Scan (Purity Check)
    needs: build-pure-kernel
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: ‚¨áÔ∏è Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: pure-kernel-${{ needs.build-pure-kernel.outputs.run_id }}
          
      - name: üîç Run Security Scan
        run: |
          echo "üîç Scanning for impurities..."
          
          # Check for forbidden patterns
          FORBIDDEN_PATTERNS=(
            "sukisu"
            "KPM"
            "SUSFS"
            "magisk"
            "kernelsu"
            "superuser"
            "rootkit"
          )
          
          echo "Scanning kernel image..."
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if strings Image.pure 2>/dev/null | grep -i "$pattern" >/dev/null; then
              echo "‚ùå SECURITY VIOLATION: $pattern found in kernel!"
              exit 1
            fi
          done
          
          echo "‚úÖ Security scan passed. Kernel is pure."

  release:
    name: üöÄ Create Release
    needs: [build-pure-kernel, security-scan]
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'workflow_dispatch'
    
    steps:
      - name: üìù Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Pure Kernel ${{ github.sha }}"
          body: |
            # üßπ Pure Kernel Build
            
            **No SUKISU, No KPM, No SUSFS, No Root Modifications**
            
            Built with full LTO optimization.
            
            ## Verification
            Run `./verify_purity.sh` to confirm no contaminants.
            
            ## Flash Instructions
            See included flash.sh script.
            
            **Philosophy:** Complexity breeds vulnerability. Simplicity breeds security.
          files: |
            artifacts.zip
          draft: false
          prerelease: false
